#summary 开发手册

= OpenJTCC构成 =
OpenJTCC主要由tcc-compensable、tcc-core、tcc-supports三部分构成，其中：
  * tcc-compensable定义了tcc与应用程序相关的接口；
  * tcc-core为openjtcc事务管理器的实现；
  * tcc-supports用于集成spring、rpc框架（如Dubbo）、DB连接池（如dbcp、druid）。

= OpenJTCC配置 =

=== Spring配置 ===
{{{
<!-- openjtcc.xml位于tcc-supports.jar包中，如无修改不需取出，直接import即可 -->
<import resource="classpath:openjtcc.xml" />

<!-- 使用数据库来记录事务日志（目前唯一可选项）时，需要配置数据源（默认为loggerDataSource，名称需与openjtcc.xml中保持一致） -->
<!-- 使用dbcp -->
<bean id="loggerDataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
	<property name="driverClassName" value="oracle.jdbc.driver.OracleDriver" />
	<property name="url" value="jdbc:oracle:thin:@192.168.29.213:1521:hshdb" />
	<property name="username" value="ptz1" />
	<property name="password" value="ptz1" />
</bean>

<!-- 使用druid -->
<!--
<bean id="loggerDataSource" class="com.alibaba.druid.pool.DruidDataSource" init-method="init" destroy-method="close">
	<property name="url" value="jdbc:oracle:thin:@192.168.29.213:1521:hshdb" />
	<property name="username" value="ptz1" />
	<property name="password" value="ptz1" />

	<property name="filters" value="stat" />

	<property name="maxActive" value="4" />
	<property name="initialSize" value="2" />
	<property name="maxWait" value="60000" />
	<property name="minIdle" value="2" />
</bean>
-->
}}}

=== Dubbo配置 ===

===== 默认属性文件openjtcc.properties =====
openjtcc.xml文件中配置了默认加载openjtcc.properties属性文件，该文件需要提供如下几个配置项：
{{{
tcc.application=tcc-demo4dubbo-server
tcc.endpoint=default
tcc.timeout=300
}}}
其中，tcc.application为当前应用名称（如tcc-demo4dubbo-server）；
tcc.endpoint为当前应用实例端点名称（如应用tcc-demo4dubbo-server部署在集群上时，则endpoint为某集群实例名称）；
tcc.timeout为事务超时时间（单位：秒）。

===== Dubbo基础配置 =====
{{{
<dubbo:application name="${tcc.application}" />
<dubbo:consumer timeout="60000" retries="0" />
<dubbo:registry address="multicast://224.5.6.7:23421" />
<dubbo:protocol name="dubbo" port="${dubbo.port}" />
<dubbo:service ref="remoteInvocationService" interface="org.bytesoft.openjtcc.supports.dubbo.RemoteInvocationService" />
}}}

===== Dubbo客户端应用配置 =====
{{{
<dubbo:reference id="remote-service" check="true" loadbalance="random" interface="org.bytesoft.openjtcc.supports.dubbo.RemoteInvocationService" />
}}}
必须提供一个id为remote-service的配置。

{{{
<dubbo:reference id="tcc-demo4dubbo-server-remote-service" check="true" url="dubbo://${tcc-server-appname}:${tcc-server-appport}" interface="org.bytesoft.openjtcc.supports.dubbo.RemoteInvocationService" />
<dubbo:reference id="tcc-demo4dubbo-server-default-remote-service" check="true" url="dubbo://${tcc-server-appname}:${tcc-server-appport}" interface="org.bytesoft.openjtcc.supports.dubbo.RemoteInvocationService" />
}}}
假设客户端应用（假设名称为tcc-demo4dubbo-client）调用的远程服务端应用名称为${tcc-server-appname}（如tcc-demo4dubbo-server）且Endpoint名称为${tcc-server-endname}，则1）除remote-service外还必须提供两个配置，其ID分别为${tcc-server-appname}-remote-service、${tcc-server-appname}-${tcc-server-endname}-remote-service；2）上述两个配置必须指定url，url为dubbo://${tcc-server-appname}:${tcc-server-appport}。<br />
注意：上文描述中的${tcc-server-appname}、${tcc-server-endname}、${tcc-server-appport}均为变量标识，需以真实值填入。